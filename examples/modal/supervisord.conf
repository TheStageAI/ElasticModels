[supervisord]
nodaemon=true
logfile=/dev/null
logfile_maxbytes=0

[program:models]
priority=10
directory=/opt/project
command=/bin/sh -lc '\
  if [ -d /runpod-volume ]; then \
    export HF_HOME="/opt/project/.cache"; \
    export HUGGINGFACE_HUB_CACHE="/opt/project/.cache/huggingface"; \
    export HF_HUB_CACHE="/opt/project/.cache/huggingface"; \
    export TRANSFORMERS_CACHE="/opt/project/.cache/huggingface/transformers"; \
    export TORCH_HOME="/opt/project/.cache/torch"; \
  fi; \
  mkdir -p /opt/project/.cache; \
  if [ -d /runpod-volume ]; then \
    mkdir -p /runpod-volume/hf; \
    ln -sfn /runpod-volume/hf /opt/project/.cache/huggingface; \
  fi; \
  exec elastic-models serve "${MODEL_TYPE}" "${MODEL_REPO}" --size "${MODEL_SIZE}" --batch "${MODEL_BATCH}" --enable-metadata-server'
stdout_logfile=/dev/fd/1
stdout_logfile_maxbytes=0
stderr_logfile=/dev/fd/2
stderr_logfile_maxbytes=0

[program:nginx]
priority=20
command=sh -lc 'until curl -sf --connect-timeout 0.2 --max-time 0.5 http://127.0.0.1:8000/v2/health/ready; do sleep 1; done; export AUTH_TOKEN; exec /usr/local/openresty/nginx/sbin/nginx -g "daemon off;"'
stdout_logfile=/dev/fd/1
stdout_logfile_maxbytes=0
stderr_logfile=/dev/fd/2
stderr_logfile_maxbytes=0